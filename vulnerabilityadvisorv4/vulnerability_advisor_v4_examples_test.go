//go:build examples
// +build examples

/**
 * (C) Copyright IBM Corp. 2023.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package vulnerabilityadvisorv4_test

import (
	"encoding/json"
	"fmt"
	"os"

	"github.com/IBM/container-registry-go-sdk/vulnerabilityadvisorv4"
	"github.com/IBM/go-sdk-core/v5/core"
	. "github.com/onsi/ginkgo"
	. "github.com/onsi/gomega"
)

//
// This file provides an example of how to use the Vulnerability Advisor service.
//
// The following configuration properties are assumed to be defined:
// VULNERABILITY_ADVISOR_URL=<service base url>
// VULNERABILITY_ADVISOR_AUTH_TYPE=iam
// VULNERABILITY_ADVISOR_APIKEY=<IAM apikey>
// VULNERABILITY_ADVISOR_AUTH_URL=<IAM token service base URL - omit this if using the production environment>
//
// These configuration properties can be exported as environment variables, or stored
// in a configuration file and then:
// export IBM_CREDENTIALS_FILE=<name of configuration file>
//

func shouldSkipTest() {
	Skip("Container Registry examples are not intended to be runnable tests")
}

var _ = Describe(`VulnerabilityAdvisorV4 Examples Tests`, func() {

	const externalConfigFile = "../vulnerability_advisor_v4.env"

	var (
		vulnerabilityAdvisorService *vulnerabilityadvisorv4.VulnerabilityAdvisorV4
		config                      map[string]string
	)

	var shouldSkipTest = func() {
		Skip("External configuration is not available, skipping examples...")
	}

	Describe(`External configuration`, func() {
		It("Successfully load the configuration", func() {
			var err error
			_, err = os.Stat(externalConfigFile)
			if err != nil {
				Skip("External configuration file not found, skipping examples: " + err.Error())
			}

			os.Setenv("IBM_CREDENTIALS_FILE", externalConfigFile)
			config, err = core.GetServiceProperties(vulnerabilityadvisorv4.DefaultServiceName)
			if err != nil {
				Skip("Error loading service properties, skipping examples: " + err.Error())
			} else if len(config) == 0 {
				Skip("Unable to load service properties, skipping examples")
			}

			// we have config but we dont want these tests to run anyway
			shouldSkipTest = func() {
				Skip("Container Registry examples are not intended to be runnable")
			}
		})
	})

	Describe(`Client initialization`, func() {
		BeforeEach(func() {
			shouldSkipTest()
		})
		It("Successfully construct the service client instance", func() {
			var err error

			// begin-common

			vulnerabilityAdvisorServiceOptions := &vulnerabilityadvisorv4.VulnerabilityAdvisorV4Options{
				Account: core.StringPtr("accountID"),
			}

			vulnerabilityAdvisorService, err = vulnerabilityadvisorv4.NewVulnerabilityAdvisorV4UsingExternalConfig(vulnerabilityAdvisorServiceOptions)

			if err != nil {
				panic(err)
			}

			// end-common

			Expect(vulnerabilityAdvisorService).ToNot(BeNil())
		})
	})

	Describe(`VulnerabilityAdvisorV4 request examples`, func() {
		BeforeEach(func() {
			shouldSkipTest()
		})
		It(`AccountReportQueryPath request example`, func() {
			fmt.Println("\nAccountReportQueryPath() result:")
			// begin-accountReportQueryPath

			accountReportQueryPathOptions := vulnerabilityAdvisorService.NewAccountReportQueryPathOptions()

			accountReportQueryPathOptions.IncludePrivate = core.StringPtr("true")

			scanReportList, response, err := vulnerabilityAdvisorService.AccountReportQueryPath(accountReportQueryPathOptions)
			if err != nil {
				panic(err)
			}
			b, _ := json.MarshalIndent(scanReportList, "", "  ")
			fmt.Println(string(b))

			// end-accountReportQueryPath

			Expect(err).To(BeNil())
			Expect(response.StatusCode).To(Equal(200))
			Expect(scanReportList).ToNot(BeNil())
		})
		It(`AccountStatusQueryPath request example`, func() {
			fmt.Println("\nAccountStatusQueryPath() result:")
			// begin-accountStatusQueryPath

			accountStatusQueryPathOptions := vulnerabilityAdvisorService.NewAccountStatusQueryPathOptions()

			scanreportImageSummaryList, response, err := vulnerabilityAdvisorService.AccountStatusQueryPath(accountStatusQueryPathOptions)
			if err != nil {
				panic(err)
			}
			b, _ := json.MarshalIndent(scanreportImageSummaryList, "", "  ")
			fmt.Println(string(b))

			// end-accountStatusQueryPath

			Expect(err).To(BeNil())
			Expect(response.StatusCode).To(Equal(200))
			Expect(scanreportImageSummaryList).ToNot(BeNil())
		})
		It(`ImageReportQueryPath request example`, func() {
			fmt.Println("\nImageReportQueryPath() result:")
			// begin-imageReportQueryPath

			imageReportQueryPathOptions := vulnerabilityAdvisorService.NewImageReportQueryPathOptions(
				"image name",
			)

			scanReport, response, err := vulnerabilityAdvisorService.ImageReportQueryPath(imageReportQueryPathOptions)
			if err != nil {
				panic(err)
			}
			b, _ := json.MarshalIndent(scanReport, "", "  ")
			fmt.Println(string(b))

			// end-imageReportQueryPath

			Expect(err).To(BeNil())
			Expect(response.StatusCode).To(Equal(200))
			Expect(scanReport).ToNot(BeNil())
		})
		It(`ImageStatusQueryPath request example`, func() {
			fmt.Println("\nImageStatusQueryPath() result:")
			// begin-imageStatusQueryPath

			imageStatusQueryPathOptions := vulnerabilityAdvisorService.NewImageStatusQueryPathOptions(
				"image name",
			)

			scanreportSummary, response, err := vulnerabilityAdvisorService.ImageStatusQueryPath(imageStatusQueryPathOptions)
			if err != nil {
				panic(err)
			}
			b, _ := json.MarshalIndent(scanreportSummary, "", "  ")
			fmt.Println(string(b))

			// end-imageStatusQueryPath

			Expect(err).To(BeNil())
			Expect(response.StatusCode).To(Equal(200))
			Expect(scanreportSummary).ToNot(BeNil())
		})
		It(`ListExemptionAccount request example`, func() {
			fmt.Println("\nListExemptionAccount() result:")
			// begin-listExemptionAccount

			listExemptionAccountOptions := vulnerabilityAdvisorService.NewListExemptionAccountOptions()

			exemption, response, err := vulnerabilityAdvisorService.ListExemptionAccount(listExemptionAccountOptions)
			if err != nil {
				panic(err)
			}
			b, _ := json.MarshalIndent(exemption, "", "  ")
			fmt.Println(string(b))

			// end-listExemptionAccount

			Expect(err).To(BeNil())
			Expect(response.StatusCode).To(Equal(200))
			Expect(exemption).ToNot(BeNil())
		})
		It(`GetExemptionAccount request example`, func() {
			fmt.Println("\nGetExemptionAccount() result:")
			// begin-getExemptionAccount

			getExemptionAccountOptions := vulnerabilityAdvisorService.NewGetExemptionAccountOptions(
				"cve",
				"CVE-2020-0001",
			)

			exemption, response, err := vulnerabilityAdvisorService.GetExemptionAccount(getExemptionAccountOptions)
			if err != nil {
				panic(err)
			}
			b, _ := json.MarshalIndent(exemption, "", "  ")
			fmt.Println(string(b))

			// end-getExemptionAccount

			Expect(err).To(BeNil())
			Expect(response.StatusCode).To(Equal(200))
			Expect(exemption).ToNot(BeNil())
		})
		It(`CreateExemptionAccount request example`, func() {
			fmt.Println("\nCreateExemptionAccount() result:")
			// begin-createExemptionAccount

			createExemptionAccountOptions := vulnerabilityAdvisorService.NewCreateExemptionAccountOptions(
				"cve",
				"CVE-2020-0001",
			)

			exemption, response, err := vulnerabilityAdvisorService.CreateExemptionAccount(createExemptionAccountOptions)
			if err != nil {
				panic(err)
			}
			b, _ := json.MarshalIndent(exemption, "", "  ")
			fmt.Println(string(b))

			// end-createExemptionAccount

			Expect(err).To(BeNil())
			Expect(response.StatusCode).To(Equal(201))
			Expect(exemption).ToNot(BeNil())
		})
		It(`ListExemptionResource request example`, func() {
			fmt.Println("\nListExemptionResource() result:")
			// begin-listExemptionResource

			listExemptionResourceOptions := vulnerabilityAdvisorService.NewListExemptionResourceOptions(
				"image name",
			)

			exemption, response, err := vulnerabilityAdvisorService.ListExemptionResource(listExemptionResourceOptions)
			if err != nil {
				panic(err)
			}
			b, _ := json.MarshalIndent(exemption, "", "  ")
			fmt.Println(string(b))

			// end-listExemptionResource

			Expect(err).To(BeNil())
			Expect(response.StatusCode).To(Equal(200))
			Expect(exemption).ToNot(BeNil())
		})
		It(`GetExemptionResource request example`, func() {
			fmt.Println("\nGetExemptionResource() result:")
			// begin-getExemptionResource

			getExemptionResourceOptions := vulnerabilityAdvisorService.NewGetExemptionResourceOptions(
				"cve",
				"CVE-2020-0001",
				"image name",
			)

			exemption, response, err := vulnerabilityAdvisorService.GetExemptionResource(getExemptionResourceOptions)
			if err != nil {
				panic(err)
			}
			b, _ := json.MarshalIndent(exemption, "", "  ")
			fmt.Println(string(b))

			// end-getExemptionResource

			Expect(err).To(BeNil())
			Expect(response.StatusCode).To(Equal(200))
			Expect(exemption).ToNot(BeNil())
		})
		It(`CreateExemptionResource request example`, func() {
			fmt.Println("\nCreateExemptionResource() result:")
			// begin-createExemptionResource

			createExemptionResourceOptions := vulnerabilityAdvisorService.NewCreateExemptionResourceOptions(
				"cve",
				"CVE-2020-0001",
				"image name",
			)

			exemption, response, err := vulnerabilityAdvisorService.CreateExemptionResource(createExemptionResourceOptions)
			if err != nil {
				panic(err)
			}
			b, _ := json.MarshalIndent(exemption, "", "  ")
			fmt.Println(string(b))

			// end-createExemptionResource

			Expect(err).To(BeNil())
			Expect(response.StatusCode).To(Equal(201))
			Expect(exemption).ToNot(BeNil())
		})
		It(`ExemptHandler request example`, func() {
			fmt.Println("\nExemptHandler() result:")
			// begin-exemptHandler

			exemptHandlerOptions := vulnerabilityAdvisorService.NewExemptHandlerOptions()

			exemptionTypeInfo, response, err := vulnerabilityAdvisorService.ExemptHandler(exemptHandlerOptions)
			if err != nil {
				panic(err)
			}
			b, _ := json.MarshalIndent(exemptionTypeInfo, "", "  ")
			fmt.Println(string(b))

			// end-exemptHandler

			Expect(err).To(BeNil())
			Expect(response.StatusCode).To(Equal(200))
			Expect(exemptionTypeInfo).ToNot(BeNil())
		})
		It(`ListAccountExemptions request example`, func() {
			fmt.Println("\nListAccountExemptions() result:")
			// begin-listAccountExemptions

			listAccountExemptionsOptions := vulnerabilityAdvisorService.NewListAccountExemptionsOptions()

			exemption, response, err := vulnerabilityAdvisorService.ListAccountExemptions(listAccountExemptionsOptions)
			if err != nil {
				panic(err)
			}
			b, _ := json.MarshalIndent(exemption, "", "  ")
			fmt.Println(string(b))

			// end-listAccountExemptions

			Expect(err).To(BeNil())
			Expect(response.StatusCode).To(Equal(200))
			Expect(exemption).ToNot(BeNil())
		})
		It(`ExemptionsAccountDeleteHandler request example`, func() {
			fmt.Println("\nExemptionsAccountDeleteHandler() result:")
			// begin-exemptionsAccountDeleteHandler

			exemptionsAccountDeleteHandlerOptions := vulnerabilityAdvisorService.NewExemptionsAccountDeleteHandlerOptions()

			exemptionDeletionInfo, response, err := vulnerabilityAdvisorService.ExemptionsAccountDeleteHandler(exemptionsAccountDeleteHandlerOptions)
			if err != nil {
				panic(err)
			}
			b, _ := json.MarshalIndent(exemptionDeletionInfo, "", "  ")
			fmt.Println(string(b))

			// end-exemptionsAccountDeleteHandler

			Expect(err).To(BeNil())
			Expect(response.StatusCode).To(Equal(200))
			Expect(exemptionDeletionInfo).ToNot(BeNil())
		})
		It(`ListImageExemptions request example`, func() {
			fmt.Println("\nListImageExemptions() result:")
			// begin-listImageExemptions

			listImageExemptionsOptions := vulnerabilityAdvisorService.NewListImageExemptionsOptions(
				"image name",
			)

			exemption, response, err := vulnerabilityAdvisorService.ListImageExemptions(listImageExemptionsOptions)
			if err != nil {
				panic(err)
			}
			b, _ := json.MarshalIndent(exemption, "", "  ")
			fmt.Println(string(b))

			// end-listImageExemptions

			Expect(err).To(BeNil())
			Expect(response.StatusCode).To(Equal(200))
			Expect(exemption).ToNot(BeNil())
		})
		It(`ListBulkImageExemptions request example`, func() {
			fmt.Println("\nListBulkImageExemptions() result:")
			// begin-listBulkImageExemptions

			listBulkImageExemptionsOptions := vulnerabilityAdvisorService.NewListBulkImageExemptionsOptions(
				[]string{"us.icr.io/birds/woodpecker:green", "us.icr.io/birds/grebe:crested"},
			)

			mapStringExemption, response, err := vulnerabilityAdvisorService.ListBulkImageExemptions(listBulkImageExemptionsOptions)
			if err != nil {
				panic(err)
			}
			b, _ := json.MarshalIndent(mapStringExemption, "", "  ")
			fmt.Println(string(b))

			// end-listBulkImageExemptions

			Expect(err).To(BeNil())
			Expect(response.StatusCode).To(Equal(200))
			Expect(mapStringExemption).ToNot(BeNil())
		})
		It(`DeleteExemptionResource request example`, func() {
			// begin-deleteExemptionResource

			deleteExemptionResourceOptions := vulnerabilityAdvisorService.NewDeleteExemptionResourceOptions(
				"cve",
				"CVE-2020-0001",
				"image name",
			)

			response, err := vulnerabilityAdvisorService.DeleteExemptionResource(deleteExemptionResourceOptions)
			if err != nil {
				panic(err)
			}
			if response.StatusCode != 200 {
				fmt.Printf("\nUnexpected response status code received from DeleteExemptionResource(): %d\n", response.StatusCode)
			}

			// end-deleteExemptionResource

			Expect(err).To(BeNil())
			Expect(response.StatusCode).To(Equal(200))
		})
		It(`DeleteExemptionAccount request example`, func() {
			// begin-deleteExemptionAccount

			deleteExemptionAccountOptions := vulnerabilityAdvisorService.NewDeleteExemptionAccountOptions(
				"cve",
				"CVE-2020-0001",
			)

			response, err := vulnerabilityAdvisorService.DeleteExemptionAccount(deleteExemptionAccountOptions)
			if err != nil {
				panic(err)
			}
			if response.StatusCode != 200 {
				fmt.Printf("\nUnexpected response status code received from DeleteExemptionAccount(): %d\n", response.StatusCode)
			}

			// end-deleteExemptionAccount

			Expect(err).To(BeNil())
			Expect(response.StatusCode).To(Equal(200))
		})
	})
})
